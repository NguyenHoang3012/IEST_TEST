<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Kiểm Tra - Multiple Choice & Fill in the Blank</title>
    <style>
		body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            font-size: 12px; 
        }
		h2 {
            font-size: 30px; /* Tăng kích thước chữ tiêu đề */
            font-weight: bold;
            color: #333;
        }
		.highlight {
    	background-color: yellow;
		}
		.underline {
			text-decoration: underline;
		}
        .table {
            margin: auto;
            border-collapse: collapse;
            border: 1px solid #ccc;
            padding: 2px;
        }
        td {
            padding: 10px;
            text-align: left;
            font-family: Arial, Helvetica, sans-serif;
        }
        .audio-container {
			 width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center; /* Căn giữa nội dung */
            gap: 10px; /* Khoảng cách giữa audio và icon */
			
            margin-top: 20px;
			width: 100%
        }
        .reload-icon {
            cursor: pointer;
            font-size: 32px;
            transition: transform 0.4s ease-in-out;
        }
        .reload-icon:active {
            transform: rotate(360deg);
        }
		        .section {
            margin-top: 20px;
        }
        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        .section-title {
            font-size: 22px;
            font-weight: bold;
            text-align: center;
        }
        .subtitle, .instruction {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            font-style: italic;
        }
        .question-container {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 14px;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .question-container ul {
            font-family: Arial, Helvetica, sans-serif;
            font-size: 14px;
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .question-container li {
            margin-bottom: 15px;
            font-size: 14px;
            display: block;
            font-family: Arial, Helvetica, sans-serif;
        }
        .column {
            width: 100%;
        }
        .question {
            margin-bottom: 10px;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }
        .input-field {    
            width: 140px;
            font-size: 14px;
            margin-left: 5px;
            margin-right: 5px;
        }
		table {
            width: 100%;
            border-collapse: collapse;
		}
        .section {
            display: none;
        }
        .active {
            display: block;
        }
        .navigation {
            text-align: center;
            margin-bottom: 20px;
			margin-top:20px
        }
        .nav-button {
            margin: 5px;
            padding: 10px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
        }
        .nav-button:hover {
            background-color: #0056b3;
        }
        .btn-submit {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.5);
        }

        .btn-submit:hover {
            background: linear-gradient(45deg, #ff4b2b, #ff416c);
            box-shadow: 0 6px 20px rgba(255, 65, 108, 0.7);
            transform: scale(1.05);
        }

        .btn-submit:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(255, 65, 108, 0.5);
        }
        .welcome-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: block;
        }
        .welcome-container h2 {
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .btn {
            width: 100%;
            background: #007bff;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover {
            background: #0056b3;
        }
        .welcome-container {
            display: none;
        }     
      
        /* ...existing styles... */
        #unanswered-questions ul {
            display: flex; /* Hiển thị các mục trên cùng một dòng */
            flex-wrap: wrap; /* Cho phép xuống dòng nếu danh sách quá dài */
            list-style: none; /* Loại bỏ dấu chấm đầu dòng */
            padding: 0;
            margin: 0;
        }

        #unanswered-questions ul li {
            margin-right: 10px; /* Khoảng cách giữa các mục */
        }
        #part4 .question-container,
        #part4 .question-container ul,
        #part4 .question-container li,
        #part4 .question-container b,
        #part4 .question-container h3 {
            font-size: 14px;
        }
        /* Đặt font cho Part 4 là Arial */
        #part4 {
            font-family: Arial, Helvetica, sans-serif;
        }
        #part4 .column {
            width: 100%;
        }
    </style>
</head>
<body>
	<div class="container info-container">
		<h2 style="text-align: center;">Insert your information</h2>
			<form onsubmit="handleInfoSubmit(event)">
				<div class="form-group">
					<label for="name">Full Name:</label>
					<input type="text" id="name" name="name" required>
				</div>
				<div class="form-group">
					<label for="class">Class:</label>
					<input type="text" id="class" name="class" required>
				</div>
				<button type="submit" class="btn">Register</button>
			</form>
		</div>
		<div class="container welcome-container">
			<h2 id="welcome-message"></h2>
		<div class="table">
		<h2 style="text-align: center;">LISTENING-TEST( ZIM_TEST-7)</h2>
		<div class="audio-container">
            <audio controls preload="auto">
                <source src="mp3/IELTS7.mp3" type="audio/mpeg">
            Trình duyệt của bạn không hỗ trợ audio.
            </audio>
			<!-- Biểu tượng reload bên dưới -->
			<span id="reloadButton" class="reload-icon">⇆</span>
		</div>
		</div>
			<div class="navigation">
			<button class="nav-button" onclick="showSection('part1')">Part 1</button>
			<button class="nav-button" onclick="showSection('part2')">Part 2</button>
			<button class="nav-button" onclick="showSection('part3')">Part 3</button>
			<button class="nav-button" onclick="showSection('part4')">Part 4</button>
		</div>
        <div id="part1" class="section active">
            <div class="table">
                <h2 class="section-title"> SESSION 1 <i>Questions 1–10</i></h2>
                <p><b>Questions 1-4</b></p>
                <p></p>Complete the form below.</p>
                <p >Write <b>TWO WORD AND/OR A NUMBER</b> for each answer.</p>
                <div class="question-container">
                    <h2>RENTAL APPLICATION FORM</h2>
                        <table border="1" style="width:100%; border-collapse:collapse; margin-bottom:20px;">
                            <tr>
                                <th colspan="2" class="form-title">
                                    ANGOULÊME HEALTH & FITNESS CLUB<br>
                                    MEMBERSHIP FORM
                                </th>
                            </tr>

                            <tr>
                                <td colspan="2" class="example">
                                    Example<br>
                                    First name: .......... Mila ..........
                                </td>
                            </tr>

                            <tr>
                                <td>Surname</td>
                                <td>1 <input type="text" class="input-field" id="q1" name="q1" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"></td>
                            </tr>

                            <tr>
                                <td>DOB</td>
                                <td>June 12<sup>th</sup>, 1992</td>
                            </tr>

                            <tr>
                                <td>Phone number</td>
                                <td>2 <input type="text" class="input-field" id="q2" name="q2" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"></td>
                            </tr>

                            <tr>
                                <td>Address</td>
                                <td>3 <input type="text" class="input-field" id="q3" name="q3" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off">, Broklion District</td>
                            </tr>

                            <tr>
                                <td>Email</td>
                                <td>4 <input type="text" class="input-field" id="q4" name="q4" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"></td>
                            </tr>
                        </table>
                </div>
                <p><b>Questions 5-10</b></p>
                <p>Complete the table below.<br>
                Write <b>NO MORE THAN TWO WORDS OR A NUMBER</b> for each answer.</p>
                <div class="question-container">
                    <table border="1" style="width:100%; border-collapse:collapse; margin-bottom:20px; font-size:14px;">
                        <tr>
                            <th>Membership types</th>
                            <th>Fee (per month)</th>
                            <th>Benefits</th>
                        </tr>

                        <tr>
                            <td>Bronze</td>
                            <td>5 $ <input type="text" class="input-field" id="q5" name="q5" autocomplete="off"></td>
                            <td>
                                <ul>
                                    <li>a 6 <input type="text" class="input-field" id="q6" name="q6" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"></li>
                                    <li>4 free sessions with one of the 7 <input type="text" class="input-field" id="q7" name="q7" autocomplete="off"></li>
                                </ul>
                            </td>
                        </tr>

                        <tr>
                            <td>Silver</td>
                            <td>$ 19.60</td>
                            <td>
                                <ul>
                                    <li>full use of the 8 <input type="text" class="input-field" id="q8" name="q8" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"></li>
                                    <li>free access to the 9 <input type="text" class="input-field" id="q9" name="q9" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"></li>
                                </ul>
                            </td>
                        </tr>

                        <tr>
                            <td>Gold</td>
                            <td>$ 24.50</td>
                            <td>
                                <ul>
                                    <li>50% off on any 10 <input type="text" class="input-field" id="q10" name="q10" autocomplete="off" spellcheck="false" autocapitalize="off" autocorrect="off"></li>
                                    <li>unlimited use of dry hydro massage</li>
                                </ul>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
	</div>
    <div id="part2" class="section">
    <div class="table">

        <h2 class="section-title">SECTION 2 <i>Questions 11-20</i></h2>

        <p class="section-title">Questions 11-16</p>
        <p class="instruction">Complete the notes below. Write <b>ONE WORD ONLY</b> for each answer.</p>

        <h3 class="section-title">PENDOLASCO ITALIAN RESTAURANT</h3>

        <div class="question-container">
            <div class="column">

                <p class="question">• A new 11 <input type="text" class="input-field" id="q11" autocomplete="off"> of a famous restaurant</p>

                <p class="question">• Located at the center of the town, near a 12 
                    <input type="text" class="input-field" id="q12" autocomplete="off">
                </p>

                <p class="question">• Has tables in the 13 
                    <input type="text" class="input-field" id="q13" autocomplete="off">
                    for customers to enjoy a romantic atmosphere
                </p>

                <p class="question">• The most famous dish uses 14 
                    <input type="text" class="input-field" id="q14" autocomplete="off">
                    as the main ingredient
                </p>

                <p class="question">• Has a special menu for 15 
                    <input type="text" class="input-field" id="q15" autocomplete="off">
                </p>

                <p class="question">• Has a small exhibition of 16 
                    <input type="text" class="input-field" id="q16" autocomplete="off">
                    equipment from the 15<sup>th</sup> century
                </p>

            </div>
        </div>

        <h2 class="section-title"><i>Questions 17-18</i></h2>
        <p class="subtitle">Choose the correct letter, A, B or C.</p>

        <div class="question-container">
            <div class="column">

                <p class="question">
                    17. The head chef of the restaurant will share special recipes
                    <br>
                    <input type="radio" name="q17" value="A"> A. on Saturday morning only.<br>
                    <input type="radio" name="q17" value="B"> B. on Saturday at noon.<br>
                    <input type="radio" name="q17" value="C"> C. on both Saturday and Sunday mornings.
                </p>

                <p class="question">
                    18. The first person to answer all 5 questions of the chef will receive a
                    <br>
                    <input type="radio" name="q18" value="A"> A. special voucher.<br>
                    <input type="radio" name="q18" value="B"> B. 20% discount.<br>
                    <input type="radio" name="q18" value="C"> C. cookbook.
                </p>

            </div>
        </div>

        <h2 class="section-title"><i>Questions 19-20</i></h2>
        <p class="subtitle">Choose <b>TWO</b> letters, A–E.</p>
        <p class="subtitle">Which TWO pieces of information does the speaker give about the buffet dinner on Sunday?</p>

        <div class="question-container">
            <div class="column">

                <p class="question">
                    <input type="checkbox" name="q19" value="A"> A. You need to reserve your seats
                </p>

                <p class="question">
                    <input type="checkbox" name="q19" value="B"> B. Children under 15 will receive a 25% discount
                </p>

                <p class="question">
                    <input type="checkbox" name="q19" value="C"> C. It only lasts for 2 hours
                </p>

                <p class="question">
                    <input type="checkbox" name="q19" value="D"> D. Seafood dishes will only be served on weekends
                </p>

                <p class="question">
                    <input type="checkbox" name="q19" value="E"> E. Some celebrities will join this dinner
                </p>

            </div>
        </div>

    </div>
    </div>
    <div id="part3" class="section">
    <div class="table">

        <h2 class="section-title">SECTION 3 <i>Questions 21-30</i></h2>

        <!-- Questions 21-23 -->
        <p class="section-title">Questions 21-23</p>
        <p class="instruction">Choose <b>THREE</b> letters, A–G.</p>
        <p class="subtitle">Which THREE courses did Dan take during his first year?</p>

        <div class="question-container">
            <div class="column">

                <p class="question"><input type="checkbox" name="q21" value="A"> A. Economic statistics</p>
                <p class="question"><input type="checkbox" name="q21" value="B"> B. Business administration</p>
                <p class="question"><input type="checkbox" name="q21" value="C"> C. Negotiation skills</p>
                <p class="question"><input type="checkbox" name="q21" value="D"> D. Statistics and probability</p>
                <p class="question"><input type="checkbox" name="q21" value="E"> E. General Informatics</p>
                <p class="question"><input type="checkbox" name="q21" value="F"> F. Business culture</p>
                <p class="question"><input type="checkbox" name="q21" value="G"> G. Environmental economics</p>

            </div>
        </div>

        <!-- Questions 24-26 -->
        <h2 class="section-title"><i>Questions 24-26</i></h2>
        <p class="subtitle">Complete the summary below.</p>
        <p class="instruction">Write <b>NO MORE THAN THREE WORDS</b> for each answer.</p>

        <h3 class="section-title">Ciri's first year experience in Erlander University</h3>

        <div class="question-container">
            <div class="column">

                <p class="question">
                    Ciri admits that it was not her own idea to study International Economics. 
                    Initially, she wanted to study 24 
                    <input type="text" class="input-field" id="q24" autocomplete="off"> 
                    but then her parents convinced her to change her mind since they think it would be easier for her to have a/an 25 
                    <input type="text" class="input-field" id="q25" autocomplete="off">.
                    She has gained a lot of essential skills and the most valuable is the ability to 26 
                    <input type="text" class="input-field" id="q26" autocomplete="off">.
                </p>

            </div>
        </div>

        <!-- Questions 27-30 -->
        <h2 class="section-title"><i>Questions 27-30</i></h2>
        <p class="subtitle">Choose the correct answer, A, B, or C.</p>

        <div class="question-container">
            <div class="column">

                <p class="question">
                    27. What does Dan think about his tutor?<br>
                    <input type="radio" name="q27" value="A"> A. He doesn’t have much time to help his students.<br>
                    <input type="radio" name="q27" value="B"> B. He has a good sense of humour.<br>
                    <input type="radio" name="q27" value="C"> C. He knows a lot about his field.
                </p>

                <p class="question">
                    28. According to Ciri, the worst thing about her study schedule is that<br>
                    <input type="radio" name="q28" value="A"> A. It occasionally changes without any notification.<br>
                    <input type="radio" name="q28" value="B"> B. Sometimes it is inaccessible.<br>
                    <input type="radio" name="q28" value="C"> C. The information displayed may be incorrect sometimes.
                </p>

                <p class="question">
                    29. Dan quit the music club because<br>
                    <input type="radio" name="q29" value="A"> A. He didn’t have enough time for it.<br>
                    <input type="radio" name="q29" value="B"> B. He didn’t get on well with the club leader.<br>
                    <input type="radio" name="q29" value="C"> C. The monthly membership fee is too high.
                </p>

                <p class="question">
                    30. What does Ciri want to do most in the summer?<br>
                    <input type="radio" name="q30" value="A"> A. Find a part-time job.<br>
                    <input type="radio" name="q30" value="B"> B. Study French.<br>
                    <input type="radio" name="q30" value="C"> C. Join a sport club.
                </p>

            </div>
        </div>

    </div>
    </div>
    <div id="part4" class="section">
    <div class="table">

        <h2 class="section-title">SECTION 4 <i>Questions 31-40</i></h2>

        <p class="subtitle">Complete the notes below.</p>
        <p class="instruction">Write <b>NO MORE THAN TWO WORDS</b> for each answer.</p>

        <h3 class="section-title">EXTERNAL BUSINESS ENVIRONMENT</h3>

        <div class="question-container">
            <div class="column">

                <p class="question">
                    <b>External micro environment:</b><br>
                    The effects of this environment on different firms may not be the same.
                </p>

                <p class="question">
                    Eg: 31 
                    <input type="text" class="input-field" id="q31" autocomplete="off">
                    may receive materials at lower prices from suppliers.
                </p>

                <p class="question"><b>Important factors of this environment:</b></p>

                <p class="question">
                    <u>Suppliers of input:</u><br>
                    - The supply of 32 
                    <input type="text" class="input-field" id="q32" autocomplete="off">
                    must be ensured.<br><br>

                    - Plants can be set up to ensure the level of inputs.<br><br>

                    - The 33 
                    <input type="text" class="input-field" id="q33" autocomplete="off">
                    input is also very important (e.g. Reliance Industries built their own facilities to produce 34 
                    <input type="text" class="input-field" id="q34" autocomplete="off">
                    ).
                </p>

                <p class="question">
                    <u>Customers:</u><br>
                    - A firm usually has different types of customers.<br><br>
                    - Companies have to spend a lot on 35 
                    <input type="text" class="input-field" id="q35" autocomplete="off">
                    to increase profits and attract customers.
                </p>

                <p class="question">
                    <u>Competitors:</u><br>
                    - Competitions between firms can take many forms.<br><br>
                    - The case of Ariel and Surf washing powder is a typical example of 36 
                    <input type="text" class="input-field" id="q36" autocomplete="off">
                    competition.
                </p>

                <p class="question">
                    <b>External Macro Environment:</b><br>
                    Factors in this environment cannot be 37 
                    <input type="text" class="input-field" id="q37" autocomplete="off">
                    .
                </p>

                <p class="question">
                    <u>Economic factor:</u><br>
                    - Economic policies from the government bring both opportunities and 38 
                    <input type="text" class="input-field" id="q38" autocomplete="off">
                    to companies.<br><br>
                    - The type of economic system provides the framework for business firms.
                </p>

                <p class="question">
                    <u>Social and cultural factor:</u><br>
                    - Activities of business firms can not only do harm to the environment, but also cause serious social costs. Therefore, businesses should be aware of the social 39 
                    <input type="text" class="input-field" id="q39" autocomplete="off">
                    of their decisions.<br><br>

                    - The concept of "social responsiveness" has been developed.<br><br>

                    - Both "social responsibility" and "social responsiveness" have a 40 
                    <input type="text" class="input-field" id="q40" autocomplete="off">
                    to ethics.
                </p>

            </div>
        </div>

        <div class="navigation">
            <button onclick="checkAnswers()" class="btn-submit">Submit</button>
            <div id="results"></div>
        </div>

    </div>
    </div>
		<div id="unanswered-questions" style="display: none; color: red; margin-top: 20px;"></div>
	 </div>
    
    <script>
	    <!-- JavaScript để hỗ trợ highlight, underline, xóa định dạng -->
					function getSelectedText() {
						let selection = window.getSelection();
						if (!selection.rangeCount) return null;
						return selection.getRangeAt(0);
					}
                            // Function to send data to Google Sheets
                    function sendDataToGoogleSheet(name, className, answers, correctCount, bandScore) {
                            const scriptURL = "https://script.google.com/macros/s/AKfycbwidojD-G4YGNDxvqkukqkc7017-dnR7UKkXQUhgrg0fz9mOwfy-GY7S6YuuUz-O8wt/exec";
                            const data = { name, className, answers, correctCount, bandScore };
                            // Lưu dữ liệu vào localStorage trước khi gửi
                            localStorage.setItem("pendingSubmission", JSON.stringify(data));
                            // Đổi nút thành Waiting...
                            const submitButton = document.querySelector(".btn-submit");
                                if (submitButton) {
                                    submitButton.innerText = "Waiting...";
                                    submitButton.disabled = true;
                                }
                            fetch(scriptURL, {
                                method: "POST",
                                mode: 'no-cors',
                                body: JSON.stringify(data),
                                headers: { "Content-Type": "application/json" }
                            })
                            .then(response => response.text())
                            .then(result => {
                                localStorage.removeItem("pendingSubmission");
                                // Đổi nút Submit thành Done
                                if (submitButton) {
                                    submitButton.innerText = "Done";
                                    submitButton.disabled = true;
                                }
                                // Cập nhật Unanswered Questions thành None
                                const unansweredContainer = document.getElementById("unanswered-questions");
                                unansweredContainer.innerHTML = `<h3>Unanswered Questions:</h3><p>None</p>`;
                                unansweredContainer.style.display = "block";
                                alert("Data sent to Google Sheets successfully!");
                            })
                            .catch(error => {
                                console.error("Error:", error);
                                alert("Failed to send data to Google Sheets. Will retry automatically when online.");
                                // Nếu gửi lỗi, cho phép thử lại  
                                if (submitButton) {
                                submitButton.innerText = "Submit";
                                submitButton.disabled = false;
                                }
                            });
                    }
                    function resendPendingSubmission() {
                        const pending = localStorage.getItem("pendingSubmission");
                        if (pending) {
                            alert("Đang gửi lại dữ liệu lên Google Sheets...");
                            const data = JSON.parse(pending);
                            fetch("https://script.google.com/macros/s/AKfycbyWWJcQBMTZio7XHQGMT0ogXegEBlg9puJQcuORQPnCZ4ymknl6GGRygJQFul5cIol_/exec", {
                                method: "POST",
                                mode: 'no-cors',
                                body: JSON.stringify(data),
                                headers: { "Content-Type": "application/json" }
                            })
                            .then(response => {
                                localStorage.removeItem("pendingSubmission");
                                const submitButton = document.querySelector(".btn-submit");
                                if (submitButton) {
                                    submitButton.innerText = "Done";
                                    submitButton.disabled = true;
                                }
                                const unansweredContainer = document.getElementById("unanswered-questions");
                                if (unansweredContainer) {
                                    unansweredContainer.innerHTML = `<h3>Unanswered Questions:</h3><p>None</p>`;
                                    unansweredContainer.style.display = "block";
                                }
                                alert("Gửi lại dữ liệu thành công!");
                            })
                            .catch(error => {
                                alert("Gửi lại dữ liệu thất bại!");
                                console.error("Error:", error);
                            });
                        } else {
                            //alert("Không có dữ liệu nào cần gửi lại.");
                        }
                    }
                    window.addEventListener('online', resendPendingSubmission);
                    window.addEventListener('DOMContentLoaded', resendPendingSubmission);
                    function wrapSelection(className) {
                            let range = getSelectedText();
                            if (!range || range.collapsed) return;

                            const clonedContent = range.cloneContents();
                            if (clonedContent.querySelector && clonedContent.querySelector("input, textarea, select, button")) return;

                            const startElement = range.startContainer.nodeType === 1
                                ? range.startContainer
                                : range.startContainer.parentElement;
                            const endElement = range.endContainer.nodeType === 1
                                ? range.endContainer
                                : range.endContainer.parentElement;

                            if (!startElement || !endElement) return;
                            if (startElement.closest("input, textarea") || endElement.closest("input, textarea")) return;

                            // Tránh bọc lồng nhiều lớp highlight cho cùng vùng đã bôi
                            if (
                                className === "highlight" &&
                                startElement.closest(".highlight") &&
                                endElement.closest(".highlight")
                            ) {
                                return;
                            }

                            let span = document.createElement("span");
                            span.className = className;

                            try {
                                // Cách này giữ khoảng trắng ổn định hơn extractContents/insertNode
                                range.surroundContents(span);
                            } catch (error) {
                                // Bỏ qua các vùng chọn phức tạp để tránh xô chữ
                                return;
                            }
                    }
					
					function highlightText() {
						wrapSelection("highlight");
					}
					
					function underlineText() {
						wrapSelection("underline");
					}

					function removeFormattingFromSelection() {
				let selection = window.getSelection();
				if (!selection.rangeCount) return;

				let range = selection.getRangeAt(0);
                let elementsToClean = [];

				function findStyledNodes(node) {
					if (node.nodeType === 1 && (node.classList.contains("highlight") || node.classList.contains("underline"))) {
                        elementsToClean.push(node);
					}
					node.childNodes.forEach(findStyledNodes);
				}

				findStyledNodes(range.commonAncestorContainer);

                elementsToClean.forEach(element => {
                    element.classList.remove("highlight", "underline");
                    if (!element.className.trim()) {
                        element.removeAttribute("class");
                    }
				});

				selection.removeAllRanges();
			}
            document.addEventListener("mouseup", function() {
                const selection = window.getSelection();
                if (selection.rangeCount && !selection.isCollapsed) {
                    const range = selection.getRangeAt(0);
                    const clonedContent = range.cloneContents();
                    let startNode = range.startContainer.nodeType === 1 ? range.startContainer : range.startContainer.parentNode;
                    let endNode = range.endContainer.nodeType === 1 ? range.endContainer : range.endContainer.parentNode;

                    if (
                        startNode && endNode &&
                        !startNode.closest("input, textarea") &&
                        !endNode.closest("input, textarea") &&
                        !(clonedContent.querySelector && clonedContent.querySelector("input, textarea, select, button"))
                    ) {
                        wrapSelection("highlight");
                        selection.removeAllRanges();
                    }
                }
            });
            document.addEventListener("click", function(e) {
                // Chỉ xóa highlight nếu click vào vùng đã bôi vàng và KHÔNG có vùng chọn nào đang active
                const selection = window.getSelection();
                if (
                    e.target.classList &&
                    e.target.classList.contains("highlight") &&
                    selection.isCollapsed // Không có vùng chọn nào đang active
                ) {
                    let parent = e.target.parentNode;
                    while (e.target.firstChild) {
                        parent.insertBefore(e.target.firstChild, e.target);
                    }
                    parent.removeChild(e.target);
                }
            });

	//Function handle Sign-in
	let name_user;
	let className_user;
        function handleInfoSubmit(event) {
            event.preventDefault();
            let name = document.getElementById("name").value;
            let className = document.getElementById("class").value;
			name_user=name;
			className_user=className;
            document.querySelector(".info-container").style.display = "none";
            document.querySelector(".welcome-container").style.display = "block";
            document.getElementById("welcome-message").innerText = `Register sucessfull,please start the test`;
        }
	//Function to check the Swap Tabs
	    function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }
                function checkAnswers() {
                const correctAnswers = {

                    // ===== SECTION 1 =====
                    q1: "Woedbeanna",
                    q2: "0712673346",
                    q3: "78 Yaruga Drive",
                    q4: "redkite.126@gmail.com",
                    q5: "16.25",
                    q6: "free T-shirt",
                    q7: "personal trainers",
                    q8: "pool",
                    q9: "movie library",
                    q10: "cold beverage",

                    // ===== SECTION 2 =====
                    q11: "branch",
                    q12: "museum",
                    q13: "garden",
                    q14: "lamb",
                    q15: "vegetarians",
                    q16: "kitchen",
                    q17: "A",
                    q18: "A",
                    q19: ["A","E"],// Includes Q19 and Q20

                    // ===== SECTION 3 =====
                    q21: ["A","B","E"],   // IN EITHER ORDER
                    q24: "External Relations",
                    q25: "entry-level job",
                    q26: "work under pressure",
                    q27: "C",
                    q28: "A",
                    q29: "B",
                    q30: "C",

                    // ===== SECTION 4 =====
                    q31: "big companies",
                    q32: "raw materials",
                    q33: "energy",
                    q34: "electricity",
                    q35: "advertisements",
                    q36: "brand",
                    q37: "controlled",
                    q38: "threats",
                    q39: "implications",
                    q40: "relation"
                };
                let correctCount = 0;
                let resultHTML = `<table><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr>`;
                const answers = {}; // Lưu câu trả lời của người dùng
                const unansweredQuestions = []; // Danh sách câu hỏi chưa trả lời

                // Lấy tất cả các câu hỏi
                const allQuestions = document.querySelectorAll('.input-field, input[type="radio"], input[type="checkbox"]');
                const processedQuestions = new Set(); // Đảm bảo mỗi câu hỏi chỉ được xử lý một lần

                allQuestions.forEach(question => {
                    const questionId = question.id || question.name; // Lấy ID hoặc name của câu hỏi
                    if (processedQuestions.has(questionId)) return; // Bỏ qua nếu đã xử lý
                    processedQuestions.add(questionId);

                    const correctAnswer = correctAnswers[questionId];
                    let userAnswer = "";

                    if (question.type === "text") {
                        userAnswer = question.value.trim();
                        if (!userAnswer) {
                            unansweredQuestions.push(questionId.replace("q", "Question "));
                        }
                    } else if (question.type === "radio") {
                        const radios = document.getElementsByName(question.name);
                        const selectedRadio = Array.from(radios).find(radio => radio.checked);
                        if (selectedRadio) {
                            userAnswer = selectedRadio.value;
                        } else {
                            unansweredQuestions.push(questionId.replace("q", "Question "));
                        }
                    } else if (question.type === "checkbox") {
                        const checkboxes = document.getElementsByName(question.name);
                        const selectedCheckboxes = Array.from(checkboxes).filter(checkbox => checkbox.checked).map(cb => cb.value);
                        userAnswer = selectedCheckboxes.join(", "); // Ghép các đáp án checkbox
                    }

                    // Kiểm tra đáp án
                    if (userAnswer) {
                        const answerForSheet =
                            question.type === "text" && /^0\d+$/.test(userAnswer)
                                ? `'${userAnswer}`
                                : userAnswer;
                        answers[questionId] = answerForSheet;

                        if (Array.isArray(correctAnswer)) {
                            // Nếu đáp án đúng là mảng (checkbox)
                            const userAnswersArray = userAnswer.split(", ").map(a => a.trim().toUpperCase());
                            const correctAnswersArray = correctAnswer.map(a => a.trim().toUpperCase());
                                // Đếm số đáp án đúng trùng khớp
                            if (userAnswersArray.length > correctAnswersArray.length) {
                            resultHTML += `<tr>
                                <td>${questionId.replace("q", "Question ")}</td>
                                <td>${userAnswer}</td>
                                <td>${correctAnswer.join(", ")}</td>
                                <td>✘ (Chọn quá số đáp án)</td>
                            </tr>`;
                        } else{
                            let matchCount = userAnswersArray.filter(ans => correctAnswersArray.includes(ans)).length;
                            correctCount += matchCount; // Mỗi đáp án đúng cộng 1 điểm
                            resultHTML += `<tr>
                                <td>${questionId.replace("q", "Question ")}</td>
                                <td>${userAnswer}</td>
                                <td>${correctAnswer.join(", ")}</td>
                                <td>${matchCount > 0 ? `+${matchCount}` : "✘"}</td>
                            </tr>`;
                        }
                        } else if (userAnswer.toUpperCase() === correctAnswer?.toUpperCase()) {
                            correctCount++;
                            resultHTML += `<tr>
                                <td>${questionId.replace("q", "Question ")}</td>
                                <td>${userAnswer}</td>
                                <td>${correctAnswer}</td>
                                <td>✔</td>
                            </tr>`;
                        } else {
                            resultHTML += `<tr>
                                <td>${questionId.replace("q", "Question ")}</td>
                                <td>${userAnswer}</td>
                                <td>${correctAnswer}</td>
                                <td>✘</td>
                            </tr>`;
                        }
                    }
                });

                // Hiển thị câu hỏi chưa trả lời
                if (unansweredQuestions.length > 0) {
                    const unansweredContainer = document.getElementById("unanswered-questions");
                    unansweredContainer.innerHTML = `<h3>Unanswered Questions:</h3><ul>${unansweredQuestions.map(q => `<li>${q}</li>`).join("")}</ul>`;
                    unansweredContainer.style.display = "block";
                    return;
                }
                // Cập nhật Unanswered Questions thành None
                const unansweredContainer = document.getElementById("unanswered-questions");
                unansweredContainer.innerHTML = `<h3>Unanswered Questions:</h3><p>None</p>`;
                unansweredContainer.style.display = "block";
                // Tính bandScore
                const bandScore = calculateBandScore(correctCount);

                // Hiển thị kết quả
                //document.getElementById("results").innerHTML = `<h2><p>${name_user} in ${className_user} class has score: ${correctCount}!</p></h2>
                //  <h3>Band Score: ${bandScore}</h3>` + resultHTML;

                // Gửi dữ liệu lên Google Sheets
                sendDataToGoogleSheet(name_user, className_user, answers, correctCount, bandScore);
            }
                // Hàm tính bandScore
                function calculateBandScore(correctCount) {
                    if (correctCount >= 39) return 9.0;
                    if (correctCount >= 37) return 8.5;
                    if (correctCount >= 35) return 8.0;
                    if (correctCount >= 33) return 7.5;
                    if (correctCount >= 30) return 7.0;
                    if (correctCount >= 27) return 6.5;
                    if (correctCount >= 23) return 6.0;
                    if (correctCount >= 20) return 5.5;
                    if (correctCount >= 16) return 5.0;
                    if (correctCount >= 13) return 4.5;
                    if (correctCount >= 10) return 4.0;
                    if (correctCount >= 7) return 3.5;
                    if (correctCount >= 5) return 3.0;
                    if (correctCount >= 3) return 2.5;
                    return 0.0;
                }
    </script>
</body>
</html>
