<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Writing Task</title>
</head>
<style>
body {
    font-family: "Times New Roman", Times, serif;
    margin: 0;
    padding: 0;
    background-color: #f9f9f9;
    font-size: 14px;
}

/* Giao diện đăng nhập */
.login-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100vh;
    background-color: #f9f9f9;
}

.login-container form {
    background-color: #fff;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    width: 300px;
    text-align: center;
}

.login-container form h2 {
    margin-bottom: 20px;
}

.login-container form label {
    display: block;
    margin-bottom: 5px;
    text-align: left;
}

.login-container form input {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.login-container form button {
    width: 100%;
    padding: 10px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    cursor: pointer;
}

.login-container form button:hover {
    background-color: #0056b3;
}

.container {
    display: none;
    flex-direction: row;
    justify-content: space-between;
    padding: 20px;
}

.task {
    width: 100%;
    background-color: #fff;
    padding: 20px;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

textarea {
            width: 100%;
            min-height: 20px;
            margin-top: 10px;
            padding: 8px;
            font-size: 12px;
            font-family: Arial, sans-serif;
            border: 1px solid #333;
            border-radius: 4px;
            resize: vertical;
}

.navigation {
    margin-bottom: 5px;
    text-align: center;
}

.nav-button {
    padding: 10px 20px;
    margin: 0 5px;
    background-color: #007bff;
    color: #fff;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
}

.nav-button:hover {
    background-color: #0056b3;
}

.task {
    display: none;
}

.task.active {
    display: block;
}

.navigation {
    display: none;
}
.btn-submit {
            display: block; /* Đảm bảo nút là một khối */
            margin: 20px auto;
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.5);
        }
.part2-textarea {
    height: 80px; /* Đặt chiều cao ngắn hơn cho textarea của Part 2 */
    width: 100%;
}
</style>
<body>
    <div class="login-container">
        <form id="login-form">
            <h2>Register</h2>
            <label for="full-name">Full Name:</label>
            <input type="text" id="full-name" name="full-name" placeholder="Enter your full name" required>
            <label for="class">Class:</label>
            <input type="text" id="class" name="class" placeholder="Enter your class" required>
            <button type="submit">Register</button>
        </form>
    </div>
            <!-- Thêm phần hiển thị thời gian đếm ngược -->
        <div id="timer" style="text-align: center; font-size: 20px; margin-bottom: 5px; color: red; display: none;">
                Time: <span id="time-remaining">40:00</span>
        </div>
    <div class="navigation">
        <button class="nav-button" data-target="part1">Part 1</button>
        <button class="nav-button" data-target="part2">Part 2</button>
    </div>
    <div class="container">
        <div id="part1" class="task">
            <div class="title">
                 <strong>Exercise 1. Translate the given sentences into English (60 points)</strong>
            </div>

            <div class="question">
                <span class="number">1.</span>
                Chính phủ đang khuyến khích người dân ăn uống lành mạnh và tập thể dục thường xuyên.
                <textarea placeholder="Write your answer here..."></textarea>
            </div>

            <div class="question">
                <span class="number">2.</span>
                Nhiều sinh viên mới tốt nghiệp đồng ý làm việc với mức lương thấp để học hỏi kinh nghiệm.
                <textarea placeholder="Write your answer here..."></textarea>
            </div>

            <div class="question">
                <span class="number">3.</span>
                Việc đọc báo hàng ngày có thể giúp người dân cập nhật thông tin hữu ích.
                <textarea placeholder="Write your answer here..."></textarea>
            </div>

            <div class="question">
                <span class="number">4.</span>
                Sử dụng mạng xã hội quá nhiều làm chúng ta gặp những vấn đề về sức khỏe như là vấn đề về mắt và đau đầu.
                <textarea placeholder="Write your answer here..."></textarea>
            </div>
            <div class="question">
                <span class="number">5.</span>
                Các thành viên sống trong một gia đình nhiều thế hệ thường có nhiều cơ hội hiểu rõ nhau hơn.
                <textarea placeholder="Write your answer here..."></textarea>
            </div>

            <div class="question">
                <span class="number">6.</span>
                Việc sống ở một khu vực nơi mà có nhiều nhà hàng là rất thuận tiện.
                <textarea placeholder="Write your answer here..."></textarea>
            </div>
        </div>
        <div id="part2" class="task" style="display: none;">    
                <div class="title">
                    <strong>Exercise 2: Paragraph development exercise (40 points)</strong>
                </div>
                <p><i>Write 3 – 4 supporting sentences for each of the following main ideas.</i></p>
                <p style="color:red; font-weight:bold;">
                    People can reap some benefits from living in big cities
                </p>
                <textarea class="part2-textarea" placeholder="Write your answer here..."></textarea>
                <p style="color:red; font-weight:bold;">
                    Using the Internet so much can bring people some drawbacks
                </p>
                <textarea class="part2-textarea" placeholder="Write your answer here..."></textarea>
            <!-- Nút nộp bài -->
            <button onclick="checkAnswers()" id="submit-all"class="btn-submit">Submit</button>
            <div id="submission-message" style="display: none; text-align: center; font-size: 20px; color: green; margin-top: 20px;">
                <!-- Thông báo sẽ được hiển thị ở đây -->
            </div>
        </div>
    </div>

    <script>

        // Lấy các phần tử cần thiết
        const loginForm = document.getElementById('login-form');
        const loginContainer = document.querySelector('.login-container');
        const mainContainer = document.querySelector('.container');
        const navigation = document.querySelector('.navigation'); // Lấy phần navigation

        // Xử lý sự kiện khi nhấn nút "Register"
        loginForm.addEventListener('submit', function(event) {
            event.preventDefault(); // Ngăn chặn reload trang
            loginContainer.style.display = 'none'; // Ẩn giao diện đăng nhập
            mainContainer.style.display = 'flex'; // Hiển thị giao diện chính
            navigation.style.display = 'block'; // Hiển thị navigation
            startTimer(); // Bắt đầu đếm ngược thời gian
        });
        // Lấy tất cả các textarea và word-count
        const textareas = document.querySelectorAll('.writing-area textarea');
        const wordCountDisplays = document.querySelectorAll('.word-count');

        // Gắn sự kiện input cho từng textarea
        textareas.forEach((textarea, index) => {
            textarea.addEventListener('input', () => {
                const text = textarea.value.trim(); // Lấy nội dung trong textarea
                const words = text === '' ? 0 : text.split(/\s+/).length; // Đếm số từ
                wordCountDisplays[index].textContent = `Word count: ${words}`; // Cập nhật hiển thị
            });
        });
            // Lấy tất cả các nút điều hướng và các phần nội dung
        const navButtons = document.querySelectorAll('.nav-button');
        const tasks = document.querySelectorAll('.task');

        // Thêm sự kiện click cho từng nút
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const target = button.getAttribute('data-target'); // Lấy giá trị data-target

                // Ẩn tất cả các phần
                tasks.forEach(task => {
                    task.classList.remove('active');
                    task.style.display = 'none'; // Ẩn phần
                });

                // Hiển thị phần được chọn
                const targetTask = document.getElementById(target);
                targetTask.classList.add('active');
                targetTask.style.display = 'block'; // Hiển thị phần
            });
        });

        // Hiển thị mặc định Part 1
            document.getElementById('part1').classList.add('active');
            document.getElementById('part1').style.display = 'block'; // Hiển thị phần 1
        function escapeForGoogleSheets(value) {
            if (typeof value !== 'string') return value;
            if (/^[=+\-@]/.test(value)) {
                return `'${value}`;
            }
            return value;
        }

        function sendDataToGoogleSheet(name, className, part1Answers, part2Answers) {
                const safePart1Answers = part1Answers.map(answer => escapeForGoogleSheets(answer || ''));
                const safePart2Answers = part2Answers.map(answer => escapeForGoogleSheets(answer || ''));

                const part1Combined = safePart1Answers
                    .map((answer, index) => `${index + 1}. ${answer}`)
                    .join('\n');

                const data = {
                    name: escapeForGoogleSheets(name),
                    className: escapeForGoogleSheets(className),
                    Q1: part1Combined,
                    Q2: '',
                    Q3: '',
                    Q4: '',
                    Q5: '',
                    Q6: '',
                    Q1_P2: safePart2Answers[0] || '',
                    Q2_P2: safePart2Answers[1] || ''
                };
                console.log("Sending data:", data); // Kiểm tra dữ liệu
                const scriptURL = "https://script.google.com/macros/s/AKfycbxaDB_bGbdRiEyGHNAdf1xmvUvm1RL5xRySvxkvyHpxtn8ov4KscPR-NTbXPF_rCSen/exec"; // Thay bằng URL của Google Apps Script
                 // Đổi nút thành Waiting...
                const submitButton = document.getElementById("submit-all");
                if (submitButton) {
                    submitButton.innerText = "Waiting...";
                    submitButton.disabled = true;
                }
                // Lưu dữ liệu vào localStorage trước khi gửi
                localStorage.setItem("pendingSubmission", JSON.stringify(data));
                fetch(scriptURL, {
                    method: "POST",
                    mode: 'no-cors',
                    body: JSON.stringify(data),
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                .then(() => {
                    localStorage.removeItem("pendingSubmission");
                    // Đổi nút Submit thành Done
                    if (submitButton) {
                                    submitButton.innerText = "Done";
                                    submitButton.disabled = true;
                    }
                    // Hiển thị thông báo thành công
                    const messageElement = document.getElementById('submission-message');
                    messageElement.textContent = "Submit sucessfully";
                    messageElement.style.display = 'block';
                })
                .catch(error => {
                    console.error("Error:", error);
                    alert("Không thể gửi dữ liệu đến Google Sheets. Vui lòng thử lại.");
                    // Nếu gửi lỗi, cho phép thử lại  
                    if (submitButton) {
                                submitButton.innerText = "Submit";
                                submitButton.disabled = false;
                            }
                    // Hiển thị thông báo cần nộp lại 
                    const messageElement = document.getElementById('submission-message');
                    messageElement.textContent = "Please try Submit button again";
                    messageElement.style.display = 'block';
                });
            }
    function checkAnswers() {
        const name = document.getElementById('full-name').value.trim();
        const className = document.getElementById('class').value.trim();
        const part1Textareas = document.querySelectorAll('#part1 textarea');
        const part2Textareas = document.querySelectorAll('#part2 textarea');
        const part1Answers = Array.from(part1Textareas).map(textarea => textarea.value.trim());
        const part2Answers = Array.from(part2Textareas).map(textarea => textarea.value.trim());
        const allAnswers = [...part1Answers, ...part2Answers].filter(Boolean);

        if (allAnswers.length === 0) {
            //alert('Vui lòng viết bài trước khi nộp!');
            part1Answers.fill('No answer');
            part2Answers.fill('No answer');
            // Dừng bộ đếm thời gian
            clearInterval(timerInterval);
            sendDataToGoogleSheet(name, className, part1Answers, part2Answers);
            return;
        }
            // Dừng bộ đếm thời gian
        clearInterval(timerInterval);
        sendDataToGoogleSheet(name, className, part1Answers, part2Answers);
    }
        // Thời gian làm bài (40 phút)
    const totalTime = 40* 60; // 40 phút * 60 giây
    let timeLeft = totalTime; // Biến lưu thời gian còn lại
    // Biến lưu interval của bộ đếm thời gian
    let timerInterval;

    // Hàm bắt đầu đếm ngược thời gian
    function startTimer() {
        const timerElement = document.getElementById('timer');
        const timeRemainingElement = document.getElementById('time-remaining');
        timerElement.style.display = 'block'; // Hiển thị bộ đếm thời gian

        timerInterval = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;

            // Cập nhật hiển thị thời gian
            timeRemainingElement.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;

            if (timeLeft <= 0) {
                clearInterval(timerInterval); // Dừng bộ đếm thời gian
                alert('Time is up! Your session has ended.');
                lockWritingAreas(); // Khóa các textarea
            }

            timeLeft--; // Giảm thời gian còn lại
        }, 1000); // Cập nhật mỗi giây
    }

    // Hàm khóa các textarea khi hết thời gian
    function lockWritingAreas() {
        const textareas = document.querySelectorAll('.writing-area textarea');
        textareas.forEach(textarea => {
            textarea.disabled = true; // Vô hiệu hóa textarea
        });
        checkAnswers();
    }
    </script>
</body>
</html>