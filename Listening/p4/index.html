<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài Kiểm Tra - Multiple Choice & Fill in the Blank</title>
    <style>
		body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            font-size: 12px; 
        }
		h2 {
            font-size: 30px; /* Tăng kích thước chữ tiêu đề */
            font-weight: bold;
            color: #333;
        }
		.highlight {
    	background-color: yellow;
		}
		.underline {
			text-decoration: underline;
		}
        .table {
            margin: auto;
            border-collapse: collapse;
            border: 1px solid #ccc;
            padding: 2px;
        }
        td {
            padding: 10px;
            text-align: center;
        }
		.title {
            font-weight: bold;
            font-size: 20px;
            text-align: center;
        }
        .audio-container {
			 width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center; /* Căn giữa nội dung */
            gap: 10px; /* Khoảng cách giữa audio và icon */
			
            margin-top: 20px;
			width: 100%
        }
        .reload-icon {
            cursor: pointer;
            font-size: 32px;
            transition: transform 0.4s ease-in-out;
        }
        .reload-icon:active {
            transform: rotate(360deg);
        }
		        .section {
            margin-top: 20px;
        }
        .section-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        .blank {
            border-bottom: 1px solid black;
            width: 100px;
            display: inline-block;
        }
		.flex-container {
            display: flex;
            justify-content: space-between;
        }
        .box {
            width: 48%;
        }
        .section-title {
            font-size: 22px;
            font-weight: bold;
            text-align: center;
        }
        .subtitle, .instruction {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
            font-style: italic;
        }
        .question-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .question-container ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .question-container li {
            margin-bottom: 15px;
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        .column {
            width: 48%;
        }
        .question {
            margin-bottom: 10px;
            font-size: 12px;
        }
        .input-field {
            margin-left: 10px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 200px;
            font-size: 12px;
        }
        select.input-field {
            cursor: pointer;
        }
        .correct {
            background-color: lightgreen;
        }
        .incorrect {
            background-color: lightcoral;
        }
		table {
            width: 100%;
            border-collapse: collapse;
		}
        .section {
            display: none;
        }
        .active {
            display: block;
        }
        .navigation {
            text-align: center;
            margin-bottom: 20px;
			margin-top:20px
        }
        .nav-button {
            margin: 5px;
            padding: 10px;
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
        }
        .nav-button:hover {
            background-color: #0056b3;
        }
        .btn-submit {
            background: linear-gradient(45deg, #ff416c, #ff4b2b);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 4px 15px rgba(255, 65, 108, 0.5);
        }

        .btn-submit:hover {
            background: linear-gradient(45deg, #ff4b2b, #ff416c);
            box-shadow: 0 6px 20px rgba(255, 65, 108, 0.7);
            transform: scale(1.05);
        }

        .btn-submit:active {
            transform: scale(0.95);
            box-shadow: 0 2px 10px rgba(255, 65, 108, 0.5);
        }
        .form-container, .welcome-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            display: block;
        }
        .form-container h2, .welcome-container h2 {
            text-align: center;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .btn {
            width: 100%;
            background: #007bff;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .btn:hover {
            background: #0056b3;
        }
        .welcome-container {
            display: none;
        }     
      
        /* ...existing styles... */
        #unanswered-questions ul {
            display: flex; /* Hiển thị các mục trên cùng một dòng */
            flex-wrap: wrap; /* Cho phép xuống dòng nếu danh sách quá dài */
            list-style: none; /* Loại bỏ dấu chấm đầu dòng */
            padding: 0;
            margin: 0;
        }

        #unanswered-questions ul li {
            margin-right: 10px; /* Khoảng cách giữa các mục */
        }
  
    </style>
</head>
<body>
	<div class="container info-container">
		<h2 style="text-align: center;">Insert your information</h2>
			<form onsubmit="handleInfoSubmit(event)">
				<div class="form-group">
					<label for="name">Full Name:</label>
					<input type="text" id="name" name="name" required>
				</div>
				<div class="form-group">
					<label for="class">Class:</label>
					<input type="text" id="class" name="class" required>
				</div>
				<button type="submit" class="btn">Register</button>
			</form>
		</div>
		<div class="container welcome-container">
			<h2 id="welcome-message"></h2>
		<div class="table">
		<h2 style="text-align: center;">LISTENING-TEST( RAT-V7-T3)</h2>
		<div class="audio-container">
			<audio id="audioPlayer" controls>
				<source id="audioSource" src="https://media.vocaroo.com/mp3/1mEY8DrYr2AN" type="audio/mp3">
				Trình duyệt của bạn không hỗ trợ audio.
			</audio>
			<!-- Biểu tượng reload bên dưới -->
			<span id="reloadButton" class="reload-icon">⇆</span>
		</div>
		</div>
			<div class="navigation">
			<button class="nav-button" onclick="showSection('part1')">Part 1</button>
			<button class="nav-button" onclick="showSection('part2')">Part 2</button>
			<button class="nav-button" onclick="showSection('part3')">Part 3</button>
			<button class="nav-button" onclick="showSection('part4')">Part 4</button>
		</div>
		<div id="part1" class="section active">
            <div class="table">
                    <h2 class="section-title">PART 1 <i>Questions 1–10</i></h2>
                    <p class="subtitle">Complete the notes below.</p>
                    <p class="subtitle">Write <b>ONE WORD AND/OR A NUMBER</b> for each answer.</p>
                    <div class="question-container">
                        <h3>Enquiries on Hot Air Balloon Trip</h3>
                        <p class="question">The lowest price: 1 £<input type="text" class="input-field" id="q1" autocomplete="off"> per person</p>
                        <p class="question">Each participant will be given a free 2 <input type="text" class="input-field" id="q2" autocomplete="off"> at the end of the flight</p>
                        <p class="question">The exact date can only be booked 3 <input type="text" class="input-field" id="q3" autocomplete="off"></p>
                        <p class="question">The balloon can fly a maximum height of 4 <input type="text" class="input-field" id="q4" autocomplete="off"> metres</p>
                        <p class="question">There are no flights at 5 <input type="text" class="input-field" id="q5" autocomplete="off"></p>
                        <p class="question">The best time of year to go is in 6 <input type="text" class="input-field" id="q6" autocomplete="off"></p>
                        <p class="question">Flights may be cancelled because of bad weather, e.g., 7 <input type="text" class="input-field" id="q7" autocomplete="off"></p>
                        <p class="question">It is advised to wear a jacket and a 8 <input type="text" class="input-field" id="q8" autocomplete="off"></p>
                        <p class="question">There is no 9 <input type="text" class="input-field" id="q9" autocomplete="off"> restriction for adults</p>
                        <p class="question">Participants must be able to 10 <input type="text" class="input-field" id="q10" autocomplete="off"> throughout the flight</p>
                    </div>
            </div> 
		</div>
	</div>
	<div id="part2" class="section">
        <div class="table">
            <h2 class="section-title">PART 2 <i>Questions 11–20</i></h2>
            <p class="subtitle">Complete the table below.</p>
            <p class="subtitle">Write <b>NO MORE THAN TWO WORDS AND/OR A NUMBER</b> for each answer.</p>
            <h3 style="text-align:center;">Spring Festival</h3>
            <div class="question-container">
                <table border="1" style="width:100%; border-collapse:collapse; margin-bottom:20px;">
                    <tr>
                        <th>Event</th>
                        <th>Location</th>
                        <th>Date and Time</th>
                        <th>Other Information</th>
                    </tr>
                    <tr>
                        <td>Firework display</td>
                        <td>Near the 11 <input type="text" class="input-field" id="q11" autocomplete="off"></td>
                        <td>4 September 9 p.m.</td>
                        <td>Pack a 12 <input type="text" class="input-field" id="q12" autocomplete="off"> and blanket</td>
                    </tr>
                    <tr>
                        <td>Display of 13 <input type="text" class="input-field" id="q13" autocomplete="off"></td>
                        <td>Central Park</td>
                        <td>daily</td>
                        <td>Buses run from the town centre every 14 <input type="text" class="input-field" id="q14" autocomplete="off"> minutes</td>
                    </tr>
                    <tr>
                        <td>The 15 <input type="text" class="input-field" id="q15" autocomplete="off"> Show</td>
                        <td>Exhibition Centre</td>
                        <td>10–15 September 9 a.m.–10 p.m.</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>‘Grow Your Imagination’</td>
                        <td>in the 16 <input type="text" class="input-field" id="q16" autocomplete="off"></td>
                        <td>11–19 September</td>
                        <td></td>
                    </tr>
                    <tr>
                        <td>‘Swing in Spring’</td>
                        <td>in the 17 <input type="text" class="input-field" id="q17" autocomplete="off"></td>
                        <td>17&amp;18 September</td>
                        <td>Saturday matinee performance at 18 <input type="text" class="input-field" id="q18" autocomplete="off"></td>
                    </tr>
                </table>
            </div>
            <!-- Questions 19 and 20 -->
            <div class="question-container">
                <h4>Questions 19 and 20</h4>
                <p class="subtitle">Choose the correct letter, <b>A</b>, <b>B</b> or <b>C</b>.</p>
                <div>
                    <p class="question">
                        19. In the Spring Festival competition, you can win<br>
                        <label><input type="radio" name="q19" value="A"> A. a family pass to ‘Balloons Down Under’.</label><br>
                        <label><input type="radio" name="q19" value="B"> B. a cheque for $200.</label><br>
                        <label><input type="radio" name="q19" value="C"> C. a flight in a hot air balloon.</label>
                    </p>
                    <p class="question">
                        20. You can get an entry form for the competition from<br>
                        <label><input type="radio" name="q20" value="A"> A. the radio station.</label><br>
                        <label><input type="radio" name="q20" value="B"> B. the newspaper.</label><br>
                        <label><input type="radio" name="q20" value="C"> C. the festival’s website.</label>
                    </p>
                </div>
            </div>  
        </div>        
	</div>
	<div id="part3" class="section">
		<div class="table">	
            <h2 class="section-title">PART 3 <i>Questions 21–30</i></h2>

            <div class="question-container">
                <h3>Questions 21–22</h3>
                <p class="subtitle">Choose <b>TWO letters, A–E</b>.</p>
                <p class="question">Which <b>TWO</b> points do the students most frequently make about their music background before entering music schools?</p>
                <div class="column">
                    <p><input type="checkbox" name="q21_22" value="A"> A. they had composed songs</p>
                    <p><input type="checkbox" name="q21_22" value="B"> B. they had relevant music qualifications</p>
                    <p><input type="checkbox" name="q21_22" value="C"> C. they played more than one instrument</p>
                    <p><input type="checkbox" name="q21_22" value="D"> D. they had played in public</p>
                    <p><input type="checkbox" name="q21_22" value="E"> E. they had piano lessons</p>
                </div>
            </div>

            <div class="question-container">
                <h3>Questions 23–24</h3>
                <p class="subtitle">Choose <b>TWO letters, A–E</b>.</p>
                <p class="question">Which <b>TWO</b> points do the students most frequently make about their music practice?</p>
                <div class="column">
                    <p><input type="checkbox" name="q23_24" value="A"> A. they practised alone</p>
                    <p><input type="checkbox" name="q23_24" value="B"> B. they practised every day</p>
                    <p><input type="checkbox" name="q23_24" value="C"> C. they were motivated by fear</p>
                    <p><input type="checkbox" name="q23_24" value="D"> D. they did not have enough practice</p>
                    <p><input type="checkbox" name="q23_24" value="E"> E. they enjoyed the challenge of playing complex pieces</p>
                </div>
            </div>

            <div class="question-container">
                <h3>Questions 25–26</h3>
                <p class="subtitle">Choose <b>TWO letters, A–E</b>.</p>
                <p class="question">Which <b>TWO</b> points do the students most frequently make about playing pieces that would be assessed?</p>
                <div class="column">
                    <p><input type="checkbox" name="q25_26" value="A"> A. they liked to hear others playing the same piece</p>
                    <p><input type="checkbox" name="q25_26" value="B"> B. they wanted to play unknown pieces</p>
                    <p><input type="checkbox" name="q25_26" value="C"> C. they played a piece by memory</p>
                    <p><input type="checkbox" name="q25_26" value="D"> D. they played a piece selected by the tutor</p>
                    <p><input type="checkbox" name="q25_26" value="E"> E. they played technical pieces</p>
                </div>
            </div>
                <h3>Questions 27–30</h3>
                <p class="subtitle">
                    What comment do the students make about the following practice?<br>
                    <i>Choose <b>FOUR</b> answers from the box and write the correct letter, <b>A–G</b>, next to Questions 27–30.</i>
                </p>
                <div class="flex-container">
                 <div class="column">
                    <div class="question-container">
                        <b>Comments</b><br>
                                <p>A it is beneficial</p>
                                <p>B it is challenging but also enjoyable</p>
                                <p>C it helps to boost confidence</p>
                                <p>D&nbsp; it is pleasant to hear</p>
                                <p>E&nbsp; it is time-consuming</p>
                                <p>F&nbsp; need to work effectively with others</p>
                                <p>G&nbsp; it happens infrequently</p>
                    </div>    
                </div>
                <div class="column">
                    <div class="question-container">
                        <p class="question">27.Play solo
                            <select class="input-field" id="q27">
                                <option value="">-- Select --</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                            </select>
                        </p>
                        <p class="question">28.Choose a piece to play 
                            <select class="input-field" id="q28">
                                <option value="">-- Select --</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                            </select>
                        </p>
                        <p class="question">29.Play different musical genres
                            <select class="input-field" id="q29">
                                <option value="">-- Select --</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                            </select>
                        </p>
                        <p class="question">30.Play duet
                            <select class="input-field" id="q30">
                                <option value="">-- Select --</option>
                                <option value="A">A</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                                <option value="D">D</option>
                                <option value="E">E</option>
                                <option value="F">F</option>
                                <option value="G">G</option>
                            </select>
                        </p>
                    </div>
                </div>
            </div>
        </div>    
	</div>
    <div id="part4" class="section">
        <div class="table">
            <h2 class="section-title">PART 4 <i>Questions 31–40</i></h2>
            <p class="subtitle"><em>Questions 31–34</em></p>
            <p class="subtitle">Choose the correct letter, <b>A</b>, <b>B</b> or <b>C</b>.</p>
            <div class="question-container">
                <p class="question">
                    31. The speaker initially chose to do her research project on Dodds because she had<br>
                    <label><input type="radio" name="q31" value="A"> A. wondered why interest in him was reviving.</label><br>
                    <label><input type="radio" name="q31" value="B"> B. been intrigued by a local building.</label><br>
                    <label><input type="radio" name="q31" value="C"> C. found his life extremely interesting.</label>
                </p>
                <p class="question">
                    32. Dodds became an architect because<br>
                    <label><input type="radio" name="q32" value="A"> A. he wanted to follow his father’s profession.</label><br>
                    <label><input type="radio" name="q32" value="B"> B. he wanted to depart from tradition.</label><br>
                    <label><input type="radio" name="q32" value="C"> C. he failed in his first choice of work.</label>
                </p>
                <p class="question">
                    33. The reason for Dodds returning to northeast England was that<br>
                    <label><input type="radio" name="q33" value="A"> A. he wanted to introduce a new style there.</label><br>
                    <label><input type="radio" name="q33" value="B"> B. there were more business opportunities there.</label><br>
                    <label><input type="radio" name="q33" value="C"> C. architects had a higher status there.</label>
                </p>
                <p class="question">
                    34. Dodds became well-known nationally when he<br>
                    <label><input type="radio" name="q34" value="A"> A. won an important architectural award.</label><br>
                    <label><input type="radio" name="q34" value="B"> B. was commissioned by the royal family.</label><br>
                    <label><input type="radio" name="q34" value="C"> C. became head of a professional association.</label>
                </p>
            </div>
            <p class="subtitle"><em>Questions 35–40</em></p>
            <p class="subtitle">Complete the table below.<br>
            Write <b>NO MORE THAN TWO WORDS</b> for each answer.</p>
            <div class="question-container">
                <table border="1" style="width:100%; border-collapse:collapse;">
                    <tr>
                        <th>Building and date</th>
                        <th>Description</th>
                        <th>Problem with design</th>
                        <th>Present use of the site</th>
                    </tr>
                    <tr>
                        <td>
                            Mitten Hall<br>
                            1824–1826
                        </td>
                        <td>Had a dome made of glass</td>
                        <td>Windows tended to 35 <input type="text" class="input-field" id="q35" autocomplete="off"></td>
                        <td>as a 36 <input type="text" class="input-field" id="q36" autocomplete="off"></td>
                    </tr>
                    <tr>
                        <td>
                            Royal Arcade<br>
                            1832
                        </td>
                        <td>Shopping centre acclaimed for its large 37 <input type="text" class="input-field" id="q37" autocomplete="off"></td>
                        <td>Difficult to make deliveries</td>
                        <td>as a 38 <input type="text" class="input-field" id="q38" autocomplete="off"> (for modern stores)</td>
                    </tr>
                    <tr>
                        <td>
                            Morton Gaol<br>
                            1839
                        </td>
                        <td>Had towers based on medieval castle design</td>
                        <td>No room for prisoners to do 39 <input type="text" class="input-field" id="q39" autocomplete="off"></td>
                        <td>as a 40 <input type="text" class="input-field" id="q40" autocomplete="off"></td>
                    </tr>
                </table>
            </div>      
            <div class="navigation">
                <button onclick="checkAnswers()" class="btn-submit">Submit</button>
                <div id="results"></div>
            </div>
           
        </div>
    </div>
    <div id="unanswered-questions" style="display: none; color: red; margin-top: 20px;"></div>
 </div>
    
    <script>
	    <!-- JavaScript để hỗ trợ highlight, underline, xóa định dạng -->
                    const correctAnswers = {
                            // PART 1
                            q1: "125",
                            q2: "certificate",
                            q3: "online",
                            q4: "1800",
                            q5: "night",
                            q6: "autumn",
                            q7: "thunderstorm",
                            q8: "helmet",
                            q9: "age",
                            q10: "stand",
                            // PART 2
                            q11: "lake",
                            q12: "picnic",
                            q13: "flowers",
                            q14: "20",
                            q15: "Motor",
                            q16: "art gallery",
                            q17: "concert hall",
        					q18: ["2.30", "2:30"], // Chấp nhận cả hai định dạng
                            q19: "C",
                            q20: "B",
                            // PART 3
                            q21_22: ["C", "D"], // IN EITHER ORDER
                            q23_24: ["C", "E"], // IN EITHER ORDER
                            q25_26: ["A", "C"], // IN EITHER ORDER
                            q27: "B",
                            q28: "E",
                            q29: "G",
                            q30: "A",
                            // PART 4
                            q31: "B",
                            q32: "B",
                            q33: "B",
                            q34: "C",
                            q35: "leak",
                            q36: "conference centre", // hoặc "conference center"
                            q37: "balcony",
                            q38: "car park",
                            q39: "exercise",
                            q40: "Transport Museum"
                };
                function getSelectedText() {
						let selection = window.getSelection();
						if (!selection.rangeCount) return null;
						return selection.getRangeAt(0);
					}
                    // ...existing code...

                    function sendDataToGoogleSheet(name, className, answers, correctCount, bandScore) {
                            const scriptURL = "https://script.google.com/macros/s/AKfycbz4WrUB-4AYRqI8YD_25XUSejt9msUsOCD-EHfJJaZibVmkNfnYdQTEuaKFNdAG2z5U/exec";
                            
                            // Tạo object chứa thông tin chi tiết về từng câu trả lời
                            const detailedAnswers = {};
                            // Phân tích từng câu trả lời
                            Object.keys(answers).forEach(questionId => {
                                const userAnswer = answers[questionId];
                                const correctAnswer = correctAnswers[questionId];
                                let isCorrect = false;
                                let status = "INCORRECT";

                                if (Array.isArray(correctAnswer)) {
                                    if (questionId.includes("_")) {
                                        // Multiple choice questions
                                        const userAnswersArray = userAnswer.split(", ").map(a => a.trim().toUpperCase());
                                        const correctAnswersArray = correctAnswer.map(a => a.trim().toUpperCase());
                                        const matchCount = userAnswersArray.filter(ans => correctAnswersArray.includes(ans)).length;
                                        
                                        if (matchCount === correctAnswersArray.length && userAnswersArray.length === correctAnswersArray.length) {
                                            status = "CORRECT";
                                            isCorrect = true;
                                        } else if (matchCount > 0) {
                                            status = "PARTIAL";
                                        } else {
                                            status = "INCORRECT";
                                        }
                                    } else {
                                        // Questions with multiple acceptable answers (like q18)
                                        isCorrect = correctAnswer.some(ans => userAnswer.toUpperCase() === ans.toUpperCase());
                                        status = isCorrect ? "CORRECT" : "INCORRECT";
                                    }
                                } else {
                                    isCorrect = userAnswer.toUpperCase() === correctAnswer?.toUpperCase();
                                    status = isCorrect ? "CORRECT" : "INCORRECT";
                                }

                                detailedAnswers[questionId] = {
                                    userAnswer: userAnswer,
                                    correctAnswer: Array.isArray(correctAnswer) ? correctAnswer.join(" or ") : correctAnswer,
                                    status: status,
                                    isCorrect: isCorrect
                                };
                            });

                            const data = { 
                                name, 
                                className, 
                                answers, 
                                correctCount, 
                                bandScore,
                                detailedAnswers: detailedAnswers,  // Thêm thông tin chi tiết
                                timestamp: new Date().toISOString() // Thêm timestamp
                            };

                            // Lưu dữ liệu vào localStorage trước khi gửi
                            localStorage.setItem("pendingSubmission", JSON.stringify(data));
                            
                            // Đổi nút thành Waiting...
                            const submitButton = document.querySelector(".btn-submit");
                            if (submitButton) {
                                submitButton.innerText = "Waiting...";
                                submitButton.disabled = true;
                            }
                            
                            fetch(scriptURL, {
                                method: "POST",
                                mode: 'no-cors',
                                body: JSON.stringify(data),
                                headers: { "Content-Type": "application/json" }
                            })
                            .then(response => response.text())
                            .then(result => {
                                localStorage.removeItem("pendingSubmission");
                                // Đổi nút Submit thành Done
                                if (submitButton) {
                                    submitButton.innerText = "Done";
                                    submitButton.disabled = true;
                                }
                                // Cập nhật Unanswered Questions thành None
                                const unansweredContainer = document.getElementById("unanswered-questions");
                                unansweredContainer.innerHTML = `<h3>Unanswered Questions:</h3><p>None</p>`;
                                unansweredContainer.style.display = "block";
                                alert("Data sent to Google Sheets successfully!");
                            })
                            .catch(error => {
                                console.error("Error:", error);
                                alert("Failed to send data to Google Sheets. Will retry automatically when online.");
                                // Nếu gửi lỗi, cho phép thử lại  
                                if (submitButton) {
                                    submitButton.innerText = "Submit";
                                    submitButton.disabled = false;
                                }
                            });
                        }
                   function resendPendingSubmission() {
                        const pending = localStorage.getItem("pendingSubmission");
                        if (pending) {
                            alert("Đang gửi lại dữ liệu lên Google Sheets...");
                            const data = JSON.parse(pending);
                            fetch("https://script.google.com/macros/s/AKfycbyWWJcQBMTZio7XHQGMT0ogXegEBlg9puJQcuORQPnCZ4ymknl6GGRygJQFul5cIol_/exec", {
                                method: "POST",
                                mode: 'no-cors',
                                body: JSON.stringify(data),
                                headers: { "Content-Type": "application/json" }
                            })
                            .then(response => {
                                localStorage.removeItem("pendingSubmission");
                                const submitButton = document.querySelector(".btn-submit");
                                if (submitButton) {
                                    submitButton.innerText = "Done";
                                    submitButton.disabled = true;
                                }
                                const unansweredContainer = document.getElementById("unanswered-questions");
                                if (unansweredContainer) {
                                    unansweredContainer.innerHTML = `<h3>Unanswered Questions:</h3><p>None</p>`;
                                    unansweredContainer.style.display = "block";
                                }
                                alert("Gửi lại dữ liệu thành công!");
                            })
                            .catch(error => {
                                alert("Gửi lại dữ liệu thất bại!");
                                console.error("Error:", error);
                            });
                        } else {
                            //alert("Không có dữ liệu nào cần gửi lại.");
                        }
                    }
                    window.addEventListener('online', resendPendingSubmission);
                    window.addEventListener('DOMContentLoaded', resendPendingSubmission);
                    function wrapSelection(className) {
                            let range = getSelectedText();
                            if (range) {
                                // Kiểm tra nếu vùng chọn nằm trong cùng một node cha
                                let startParent = range.startContainer.parentNode;
                                let endParent = range.endContainer.parentNode;
                                if (startParent === endParent) {
                                    let span = document.createElement("span");
                                    span.className = className;
                                    span.appendChild(range.extractContents());
                                    range.insertNode(span);
                                } else {
                                    alert("Chỉ có thể bôi đen trong cùng một dòng hoặc đoạn!");
                                }
                            }
                    }
					
					function highlightText() {
						wrapSelection("highlight");
					}
					
					function underlineText() {
						wrapSelection("underline");
					}

					function removeFormattingFromSelection() {
				let selection = window.getSelection();
				if (!selection.rangeCount) return;

				let range = selection.getRangeAt(0);
				let elementsToRemove = [];

				function findStyledNodes(node) {
					if (node.nodeType === 1 && (node.classList.contains("highlight") || node.classList.contains("underline"))) {
						elementsToRemove.push(node);
					}
					node.childNodes.forEach(findStyledNodes);
				}

				findStyledNodes(range.commonAncestorContainer);

				elementsToRemove.forEach(element => {
					let parent = element.parentNode;
					while (element.firstChild) {
						parent.insertBefore(element.firstChild, element);
					}
					parent.removeChild(element);
				});

				selection.removeAllRanges();
			}


        			document.addEventListener("mouseup", function() {
                const selection = window.getSelection();
                if (selection.rangeCount && !selection.isCollapsed) {
                    const range = selection.getRangeAt(0);
                    // Không highlight nếu vùng chọn nằm trong input, textarea
                    let startNode = range.startContainer.parentNode;
                    let endNode = range.endContainer.parentNode;
                    if (
                        !["INPUT", "TEXTAREA"].includes(startNode.nodeName) &&
                        !["INPUT", "TEXTAREA"].includes(endNode.nodeName)
                    ) {
                        wrapSelection("highlight");
                        selection.removeAllRanges();
                    }
                }
            });
            document.addEventListener("keydown", function(e) {
                // Nếu nhấn Ctrl+R (hoặc Cmd+R trên Mac)
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "r") {
                    e.preventDefault(); // Ngăn reload trang
                    removeFormattingFromSelection();
                }
            });
            document.addEventListener("click", function(e) {
                // Chỉ xóa highlight nếu click vào vùng đã bôi vàng và KHÔNG có vùng chọn nào đang active
                const selection = window.getSelection();
                if (
                    e.target.classList &&
                    e.target.classList.contains("highlight") &&
                    selection.isCollapsed // Không có vùng chọn nào đang active
                ) {
                    let parent = e.target.parentNode;
                    while (e.target.firstChild) {
                        parent.insertBefore(e.target.firstChild, e.target);
                    }
                    parent.removeChild(e.target);
                }
            });

	//Function handle Sign-in
	let name_user;
	let className_user;
        function handleInfoSubmit(event) {
            event.preventDefault();
            let name = document.getElementById("name").value;
            let className = document.getElementById("class").value;
			name_user=name;
			className_user=className;
            document.querySelector(".info-container").style.display = "none";
            document.querySelector(".welcome-container").style.display = "block";
            document.getElementById("welcome-message").innerText = `Register sucessfull,please start the test`;
        }
	//Function to check the Swap Tabs
	    function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }
        function checkAnswers() {

                let correctCount = 0;
                let resultHTML = `<table><tr><th>Question</th><th>Your Answer</th><th>Correct Answer</th><th>Result</th></tr>`;
                const answers = {}; // Lưu câu trả lời của người dùng
                const unansweredQuestions = []; // Danh sách câu hỏi chưa trả lời

                // Lấy tất cả các câu hỏi
                const allQuestions = document.querySelectorAll('.input-field, input[type="radio"], input[type="checkbox"], select');
                const processedQuestions = new Set(); // Đảm bảo mỗi câu hỏi chỉ được xử lý một lần

                allQuestions.forEach(question => {
                    const questionId = question.id || question.name; // Lấy ID hoặc name của câu hỏi
                    if (processedQuestions.has(questionId)) return; // Bỏ qua nếu đã xử lý
                    processedQuestions.add(questionId);

                    const correctAnswer = correctAnswers[questionId];
                    let userAnswer = "";

                    if (question.tagName === "SELECT") {
                        userAnswer = question.value.trim();
                        if (!userAnswer) {
                            unansweredQuestions.push(questionId.replace("q", "Question "));
                        }
                    } else if (question.type === "text") {
                        userAnswer = question.value.trim();
                        if (!userAnswer) {
                            unansweredQuestions.push(questionId.replace("q", "Question "));
                        }
                    } else if (question.type === "radio") {
                        const radios = document.getElementsByName(question.name);
                        const selectedRadio = Array.from(radios).find(radio => radio.checked);
                        if (selectedRadio) {
                            userAnswer = selectedRadio.value;
                        } else {
                            unansweredQuestions.push(questionId.replace("q", "Question "));
                        }
                    } else if (question.type === "checkbox") {
                        const checkboxes = document.getElementsByName(question.name);
                        const selectedCheckboxes = Array.from(checkboxes).filter(checkbox => checkbox.checked).map(cb => cb.value);
                        userAnswer = selectedCheckboxes.join(", "); // Ghép các đáp án checkbox
                    }

                    // Kiểm tra đáp án
                    if (userAnswer) {
                        answers[questionId] = userAnswer;

            if (Array.isArray(correctAnswer)) {
                // Kiểm tra xem có phải là câu hỏi multiple choice/checkbox không
                if (questionId.includes("_")) {
                    // Xử lý câu hỏi checkbox multiple choice
                    const userAnswersArray = userAnswer.split(", ").map(a => a.trim().toUpperCase());
                    const correctAnswersArray = correctAnswer.map(a => a.trim().toUpperCase());
                    
                    if (userAnswersArray.length > correctAnswersArray.length) {
                        resultHTML += `<tr>
                            <td>${questionId.replace("q", "Question ")}</td>
                            <td>${userAnswer}</td>
                            <td>${correctAnswer.join(", ")}</td>
                            <td>✘ (Chọn quá số đáp án)</td>
                        </tr>`;
                    } else {
                        let matchCount = userAnswersArray.filter(ans => correctAnswersArray.includes(ans)).length;
                        correctCount += matchCount; // Mỗi đáp án đúng cộng 1 điểm
                        resultHTML += `<tr>
                            <td>${questionId.replace("q", "Question ")}</td>
                            <td>${userAnswer}</td>
                            <td>${correctAnswer.join(", ")}</td>
                            <td>${matchCount > 0 ? `+${matchCount}` : "✘"}</td>
                        </tr>`;
                    }
                } else {
                    // Xử lý câu hỏi có nhiều đáp án đúng (như q18: ["2.30", "2:30"])
                    const isCorrect = correctAnswer.some(ans => userAnswer.toUpperCase() === ans.toUpperCase());
                    if (isCorrect) {
                        correctCount++;
                        resultHTML += `<tr>
                            <td>${questionId.replace("q", "Question ")}</td>
                            <td>${userAnswer}</td>
                            <td>${correctAnswer.join(" or ")}</td>
                            <td>✔</td>
                        </tr>`;
                    } else {
                        resultHTML += `<tr>
                            <td>${questionId.replace("q", "Question ")}</td>
                            <td>${userAnswer}</td>
                            <td>${correctAnswer.join(" or ")}</td>
                            <td>✘</td>
                        </tr>`;
                    }
                }
            } else if (userAnswer.toUpperCase() === correctAnswer?.toUpperCase()) {
                correctCount++;
                resultHTML += `<tr>
                    <td>${questionId.replace("q", "Question ")}</td>
                    <td>${userAnswer}</td>
                    <td>${correctAnswer}</td>
                    <td>✔</td>
                </tr>`;
            } else {
                resultHTML += `<tr>
                    <td>${questionId.replace("q", "Question ")}</td>
                    <td>${userAnswer}</td>
                    <td>${correctAnswer}</td>
                    <td>✘</td>
                </tr>`;
            }
        }
    });

                // Hiển thị câu hỏi chưa trả lời
                if (unansweredQuestions.length > 0) {
                    const unansweredContainer = document.getElementById("unanswered-questions");
                    unansweredContainer.innerHTML = `<h3>Unanswered Questions:</h3><ul>${unansweredQuestions.map(q => `<li>${q}</li>`).join("")}</ul>`;
                    unansweredContainer.style.display = "block";
                    return;
                }
                // Cập nhật Unanswered Questions thành None
                const unansweredContainer = document.getElementById("unanswered-questions");
                unansweredContainer.innerHTML = `<h3>Unanswered Questions:</h3><p>None</p>`;
                unansweredContainer.style.display = "block";
                // Tính bandScore
                const bandScore = calculateBandScore(correctCount);

                // Hiển thị kết quả
                //document.getElementById("results").innerHTML = `<h2><p>${name_user} in ${className_user} class has score: ${correctCount}!</p></h2>
                //   <h3>Band Score: ${bandScore}</h3>` + resultHTML;

                // Gửi dữ liệu lên Google Sheets
                sendDataToGoogleSheet(name_user, className_user, answers, correctCount, bandScore);
            }
                // Hàm tính bandScore
                function calculateBandScore(correctCount) {
                    if (correctCount >= 39) return 9.0;
                    if (correctCount >= 37) return 8.5;
                    if (correctCount >= 35) return 8.0;
                    if (correctCount >= 33) return 7.5;
                    if (correctCount >= 30) return 7.0;
                    if (correctCount >= 27) return 6.5;
                    if (correctCount >= 23) return 6.0;
                    if (correctCount >= 20) return 5.5;
                    if (correctCount >= 16) return 5.0;
                    if (correctCount >= 13) return 4.5;
                    if (correctCount >= 10) return 4.0;
                    if (correctCount >= 7) return 3.5;
                    if (correctCount >= 5) return 3.0;
                    if (correctCount >= 3) return 2.5;
                    return 0.0;
                }
    </script>
</body>
</html>
